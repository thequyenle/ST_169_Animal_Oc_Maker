<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/st169_animal_oc_maker/ui/suggestion/SuggestionActivity.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/st169_animal_oc_maker/ui/suggestion/SuggestionActivity.kt" />
              <option name="originalContent" value="package com.example.st169_animal_oc_maker.ui.suggestion&#10;&#10;import android.content.Intent&#10;import android.graphics.Bitmap&#10;import android.util.Log&#10;import android.view.LayoutInflater&#10;import androidx.activity.viewModels&#10;import androidx.lifecycle.lifecycleScope&#10;import com.example.st169_animal_oc_maker.core.base.BaseActivity&#10;import com.example.st169_animal_oc_maker.core.extensions.handleBack&#10;import com.example.st169_animal_oc_maker.core.extensions.onSingleClick&#10;import com.example.st169_animal_oc_maker.core.helper.InternetHelper&#10;import com.example.st169_animal_oc_maker.core.utils.key.IntentKey&#10;import com.example.st169_animal_oc_maker.data.suggestion.SuggestionModel&#10;import com.example.st169_animal_oc_maker.databinding.ActivitySuggestionBinding&#10;import com.example.st169_animal_oc_maker.ui.customize.CustomizeActivity&#10;import com.example.st169_animal_oc_maker.ui.home.DataViewModel&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.flow.first&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.withContext&#10;&#10;class SuggestionActivity : BaseActivity&lt;ActivitySuggestionBinding&gt;() {&#10;&#10;    private val dataViewModel: DataViewModel by viewModels()&#10;    private val suggestionViewModel: SuggestionViewModel by viewModels()&#10;&#10;    private lateinit var tommyAdapter: SuggestionAdapter&#10;    private lateinit var mileyAdapter: SuggestionAdapter&#10;    private lateinit var dammyAdapter: SuggestionAdapter&#10;&#10;    override fun setViewBinding(): ActivitySuggestionBinding {&#10;        return ActivitySuggestionBinding.inflate(LayoutInflater.from(this))&#10;    }&#10;&#10;    override fun initView() {&#10;        // Setup RecyclerViews và adapters&#10;        setupRecyclerViews()&#10;&#10;        // Observe suggestions - chỉ setup adapters một lần&#10;        lifecycleScope.launch {&#10;            suggestionViewModel.suggestions.collect { suggestions -&gt;&#10;                if (suggestions.isNotEmpty()) {&#10;                    dismissLoading()&#10;                    displaySuggestions(suggestions)&#10;                    Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Displayed ${suggestions.size} suggestions&quot;)&#10;                }&#10;            }&#10;        }&#10;&#10;        // Observe thumbnails - chỉ update thumbnails trong adapters&#10;        lifecycleScope.launch {&#10;            suggestionViewModel.thumbnails.collect { thumbnails -&gt;&#10;                if (thumbnails.isNotEmpty()) {&#10;                    updateThumbnails(thumbnails)&#10;                    Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Updated ${thumbnails.size} thumbnails&quot;)&#10;                }&#10;            }&#10;        }&#10;&#10;        // Load data&#10;        lifecycleScope.launch {&#10;            showLoading()&#10;            try {&#10;                withContext(Dispatchers.IO) {&#10;                    dataViewModel.ensureData(this@SuggestionActivity)&#10;                    val allData = dataViewModel.allData.first { it.isNotEmpty() }&#10;&#10;                    Log.d(&quot;SuggestionActivity&quot;, &quot; Starting to generate 10 suggestions per category (optimized)...&quot;)&#10;&#10;                    // Generate 10 suggestions per category (optimized với semaphore để tránh lag/crash)&#10;                    suggestionViewModel.generateAllSuggestions(&#10;                        allData,&#10;                        this@SuggestionActivity,&#10;                        suggestionsPerCategory = 10&#10;                    )&#10;                }&#10;            } catch (e: Exception) {&#10;                dismissLoading()&#10;                Log.e(&quot;SuggestionActivity&quot;, &quot;❌ Error loading data: ${e.message}&quot;)&#10;                e.printStackTrace()&#10;            }&#10;        }&#10;    }&#10;&#10;    private fun setupRecyclerViews() {&#10;        // XML đã có layoutManager và spanCount, chỉ cần config thêm&#10;        binding.rcvTommy.isNestedScrollingEnabled = false&#10;        binding.rcvMiley.isNestedScrollingEnabled = false&#10;        binding.rcvDammy.isNestedScrollingEnabled = false&#10;    }&#10;&#10;    override fun viewListener() {&#10;        binding.btnBack.onSingleClick {&#10;            handleBack()&#10;        }&#10;    }&#10;&#10;    private fun displaySuggestions(suggestions: List&lt;SuggestionModel&gt;) {&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;========================================&quot;)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot; DISPLAYING SUGGESTIONS&quot;)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Total suggestions received: ${suggestions.size}&quot;)&#10;&#10;        // Tommy suggestions (category 0) - 10 items&#10;        val tommySuggestions = suggestions.filter { it.categoryPosition == 0 }.take(10)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Tommy filtered: ${tommySuggestions.size} items&quot;)&#10;        if (!::tommyAdapter.isInitialized) {&#10;            tommyAdapter = SuggestionAdapter(::openCustomizeWithSuggestion)&#10;            binding.rcvTommy.adapter = tommyAdapter&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;Tommy adapter initialized&quot;)&#10;        }&#10;        tommyAdapter.submitList(tommySuggestions) {&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Tommy adapter list submitted: ${tommySuggestions.size} items&quot;)&#10;        }&#10;&#10;        // Miley suggestions (category 1) - 10 items&#10;        val mileySuggestions = suggestions.filter { it.categoryPosition == 1 }.take(10)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Miley filtered: ${mileySuggestions.size} items&quot;)&#10;        if (!::mileyAdapter.isInitialized) {&#10;            mileyAdapter = SuggestionAdapter(::openCustomizeWithSuggestion)&#10;            binding.rcvMiley.adapter = mileyAdapter&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;Miley adapter initialized&quot;)&#10;        }&#10;        mileyAdapter.submitList(mileySuggestions) {&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Miley adapter list submitted: ${mileySuggestions.size} items&quot;)&#10;        }&#10;&#10;        // Dammy suggestions (category 2) - 10 items&#10;        val dammySuggestions = suggestions.filter { it.categoryPosition == 2 }.take(10)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Dammy filtered: ${dammySuggestions.size} items&quot;)&#10;        if (!::dammyAdapter.isInitialized) {&#10;            dammyAdapter = SuggestionAdapter(::openCustomizeWithSuggestion)&#10;            binding.rcvDammy.adapter = dammyAdapter&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;Dammy adapter initialized&quot;)&#10;        }&#10;        dammyAdapter.submitList(dammySuggestions) {&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Dammy adapter list submitted: ${dammySuggestions.size} items&quot;)&#10;        }&#10;&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;========================================&quot;)&#10;    }&#10;&#10;    private fun updateThumbnails(thumbnails: Map&lt;String, Bitmap&gt;) {&#10;        if (::tommyAdapter.isInitialized) {&#10;            tommyAdapter.updateThumbnails(thumbnails)&#10;        }&#10;        if (::mileyAdapter.isInitialized) {&#10;            mileyAdapter.updateThumbnails(thumbnails)&#10;        }&#10;        if (::dammyAdapter.isInitialized) {&#10;            dammyAdapter.updateThumbnails(thumbnails)&#10;        }&#10;    }&#10;&#10;    private fun openCustomizeWithSuggestion(suggestion: SuggestionModel) {&#10;        if (suggestion.characterIndex == 1 || suggestion.characterIndex == 2) {&#10;            if (!InternetHelper.checkInternet(this)) {&#10;                showNoInternetDialog()&#10;                return&#10;            }&#10;        }&#10;&#10;        val intent = Intent(this, CustomizeActivity::class.java).apply {&#10;            putExtra(IntentKey.CATEGORY_POSITION_KEY, suggestion.categoryPosition)&#10;            putExtra(IntentKey.CHARACTER_INDEX, suggestion.characterIndex)&#10;            putExtra(IntentKey.IS_SUGGESTION, true)&#10;            putExtra(IntentKey.SUGGESTION_STATE, suggestion.randomState.toJson())&#10;            putExtra(IntentKey.SUGGESTION_BACKGROUND, suggestion.background)&#10;        }&#10;        startActivity(intent)&#10;    }&#10;&#10;    override fun initText() {}&#10;}" />
              <option name="updatedContent" value="package com.example.st169_animal_oc_maker.ui.suggestion&#10;&#10;import android.content.Intent&#10;import android.graphics.Bitmap&#10;import android.util.Log&#10;import android.view.LayoutInflater&#10;import androidx.activity.viewModels&#10;import androidx.lifecycle.lifecycleScope&#10;import com.example.st169_animal_oc_maker.core.base.BaseActivity&#10;import com.example.st169_animal_oc_maker.core.extensions.handleBack&#10;import com.example.st169_animal_oc_maker.core.extensions.onSingleClick&#10;import com.example.st169_animal_oc_maker.core.helper.InternetHelper&#10;import com.example.st169_animal_oc_maker.core.utils.key.IntentKey&#10;import com.example.st169_animal_oc_maker.data.suggestion.SuggestionModel&#10;import com.example.st169_animal_oc_maker.databinding.ActivitySuggestionBinding&#10;import com.example.st169_animal_oc_maker.ui.customize.CustomizeActivity&#10;import com.example.st169_animal_oc_maker.ui.home.DataViewModel&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.flow.first&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.withContext&#10;&#10;class SuggestionActivity : BaseActivity&lt;ActivitySuggestionBinding&gt;() {&#10;&#10;    private val dataViewModel: DataViewModel by viewModels()&#10;    private val suggestionViewModel: SuggestionViewModel by viewModels()&#10;&#10;    private lateinit var tommyAdapter: SuggestionAdapter&#10;    private lateinit var mileyAdapter: SuggestionAdapter&#10;    private lateinit var dammyAdapter: SuggestionAdapter&#10;&#10;    override fun setViewBinding(): ActivitySuggestionBinding {&#10;        return ActivitySuggestionBinding.inflate(LayoutInflater.from(this))&#10;    }&#10;&#10;    override fun initView() {&#10;        // Setup RecyclerViews và adapters&#10;        setupRecyclerViews()&#10;&#10;        // Observe suggestions - chỉ setup adapters một lần&#10;        lifecycleScope.launch {&#10;            suggestionViewModel.suggestions.collect { suggestions -&gt;&#10;                if (suggestions.isNotEmpty()) {&#10;                    dismissLoading()&#10;                    displaySuggestions(suggestions)&#10;                    Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Displayed ${suggestions.size} suggestions&quot;)&#10;                }&#10;            }&#10;        }&#10;&#10;        // Observe thumbnails - chỉ update thumbnails trong adapters&#10;        lifecycleScope.launch {&#10;            suggestionViewModel.thumbnails.collect { thumbnails -&gt;&#10;                if (thumbnails.isNotEmpty()) {&#10;                    updateThumbnails(thumbnails)&#10;                    Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Updated ${thumbnails.size} thumbnails&quot;)&#10;                }&#10;            }&#10;        }&#10;&#10;        // Load data&#10;        lifecycleScope.launch {&#10;            showLoading()&#10;            try {&#10;                withContext(Dispatchers.IO) {&#10;                    dataViewModel.ensureData(this@SuggestionActivity)&#10;                    val allData = dataViewModel.allData.first { it.isNotEmpty() }&#10;&#10;                    Log.d(&quot;SuggestionActivity&quot;, &quot; Starting to generate 10 suggestions per category (optimized)...&quot;)&#10;&#10;                    // Generate 10 suggestions per category (optimized với semaphore để tránh lag/crash)&#10;                    suggestionViewModel.generateAllSuggestions(&#10;                        allData,&#10;                        this@SuggestionActivity,&#10;                        suggestionsPerCategory = 10&#10;                    )&#10;                }&#10;            } catch (e: Exception) {&#10;                dismissLoading()&#10;                Log.e(&quot;SuggestionActivity&quot;, &quot;❌ Error loading data: ${e.message}&quot;)&#10;                e.printStackTrace()&#10;            }&#10;        }&#10;    }&#10;&#10;    private fun setupRecyclerViews() {&#10;        // Use WrapContentGridLayoutManager to properly handle wrap_content in ScrollView&#10;        binding.rcvTommy.apply {&#10;            layoutManager = com.example.st169_animal_oc_maker.core.custom.WrapContentGridLayoutManager(this@SuggestionActivity, 2)&#10;            isNestedScrollingEnabled = false&#10;        }&#10;        binding.rcvMiley.apply {&#10;            layoutManager = com.example.st169_animal_oc_maker.core.custom.WrapContentGridLayoutManager(this@SuggestionActivity, 2)&#10;            isNestedScrollingEnabled = false&#10;        }&#10;        binding.rcvDammy.apply {&#10;            layoutManager = com.example.st169_animal_oc_maker.core.custom.WrapContentGridLayoutManager(this@SuggestionActivity, 2)&#10;            isNestedScrollingEnabled = false&#10;        }&#10;    }&#10;&#10;    override fun viewListener() {&#10;        binding.btnBack.onSingleClick {&#10;            handleBack()&#10;        }&#10;    }&#10;&#10;    private fun displaySuggestions(suggestions: List&lt;SuggestionModel&gt;) {&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;========================================&quot;)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot; DISPLAYING SUGGESTIONS&quot;)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Total suggestions received: ${suggestions.size}&quot;)&#10;&#10;        // Tommy suggestions (category 0) - 10 items&#10;        val tommySuggestions = suggestions.filter { it.categoryPosition == 0 }.take(10)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Tommy filtered: ${tommySuggestions.size} items&quot;)&#10;        if (!::tommyAdapter.isInitialized) {&#10;            tommyAdapter = SuggestionAdapter(::openCustomizeWithSuggestion)&#10;            binding.rcvTommy.adapter = tommyAdapter&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;Tommy adapter initialized&quot;)&#10;        }&#10;        tommyAdapter.submitList(tommySuggestions) {&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Tommy adapter list submitted: ${tommySuggestions.size} items&quot;)&#10;            // Force RecyclerView to remeasure to show all items&#10;            binding.rcvTommy.requestLayout()&#10;        }&#10;&#10;        // Miley suggestions (category 1) - 10 items&#10;        val mileySuggestions = suggestions.filter { it.categoryPosition == 1 }.take(10)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Miley filtered: ${mileySuggestions.size} items&quot;)&#10;        if (!::mileyAdapter.isInitialized) {&#10;            mileyAdapter = SuggestionAdapter(::openCustomizeWithSuggestion)&#10;            binding.rcvMiley.adapter = mileyAdapter&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;Miley adapter initialized&quot;)&#10;        }&#10;        mileyAdapter.submitList(mileySuggestions) {&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Miley adapter list submitted: ${mileySuggestions.size} items&quot;)&#10;            // Force RecyclerView to remeasure to show all items&#10;            binding.rcvMiley.requestLayout()&#10;        }&#10;&#10;        // Dammy suggestions (category 2) - 10 items&#10;        val dammySuggestions = suggestions.filter { it.categoryPosition == 2 }.take(10)&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;Dammy filtered: ${dammySuggestions.size} items&quot;)&#10;        if (!::dammyAdapter.isInitialized) {&#10;            dammyAdapter = SuggestionAdapter(::openCustomizeWithSuggestion)&#10;            binding.rcvDammy.adapter = dammyAdapter&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;Dammy adapter initialized&quot;)&#10;        }&#10;        dammyAdapter.submitList(dammySuggestions) {&#10;            Log.d(&quot;SuggestionActivity&quot;, &quot;✅ Dammy adapter list submitted: ${dammySuggestions.size} items&quot;)&#10;            // Force RecyclerView to remeasure to show all items&#10;            binding.rcvDammy.requestLayout()&#10;        }&#10;&#10;        Log.d(&quot;SuggestionActivity&quot;, &quot;========================================&quot;)&#10;    }&#10;&#10;    private fun updateThumbnails(thumbnails: Map&lt;String, Bitmap&gt;) {&#10;        if (::tommyAdapter.isInitialized) {&#10;            tommyAdapter.updateThumbnails(thumbnails)&#10;        }&#10;        if (::mileyAdapter.isInitialized) {&#10;            mileyAdapter.updateThumbnails(thumbnails)&#10;        }&#10;        if (::dammyAdapter.isInitialized) {&#10;            dammyAdapter.updateThumbnails(thumbnails)&#10;        }&#10;    }&#10;&#10;    private fun openCustomizeWithSuggestion(suggestion: SuggestionModel) {&#10;        if (suggestion.characterIndex == 1 || suggestion.characterIndex == 2) {&#10;            if (!InternetHelper.checkInternet(this)) {&#10;                showNoInternetDialog()&#10;                return&#10;            }&#10;        }&#10;&#10;        val intent = Intent(this, CustomizeActivity::class.java).apply {&#10;            putExtra(IntentKey.CATEGORY_POSITION_KEY, suggestion.categoryPosition)&#10;            putExtra(IntentKey.CHARACTER_INDEX, suggestion.characterIndex)&#10;            putExtra(IntentKey.IS_SUGGESTION, true)&#10;            putExtra(IntentKey.SUGGESTION_STATE, suggestion.randomState.toJson())&#10;            putExtra(IntentKey.SUGGESTION_BACKGROUND, suggestion.background)&#10;        }&#10;        startActivity(intent)&#10;    }&#10;&#10;    override fun initText() {}&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>